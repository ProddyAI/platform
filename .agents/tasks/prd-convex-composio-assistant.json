{
	"document_type": "PRD",
	"version": "1.1",
	"status": "draft",
	"created_at": "2026-02-12",
	"title": "Proddy AI Assistant (Convex + Composio) - Codebase Aligned",
	"slug": "convex-composio-assistant",
	"request_context": "User requested a PRD for an AI assistant based on Convex DB that connects to external tools via Composio, and asked to base it on the current codebase where most parts already exist.",
	"product_summary": "Proddy already includes a Convex-backed AI assistant with conversation persistence, internal workspace tools, and Composio-powered external tool actions. This PRD defines completion criteria to move the existing implementation from feature-rich draft state to reliable production behavior.",
	"current_implementation": {
		"assistant_runtime": {
			"status": "implemented",
			"details": [
				"Conversation lifecycle and streaming are wired through `@dayhaysoos/convex-database-chat`.",
				"Assistant actions are implemented in Convex (`assistantChat.sendMessage`) with OpenAI tool-calling.",
				"Workspace assistant UI is available at `/workspace/[workspaceId]/assistant`."
			],
			"evidence_files": [
				"convex/assistantChat.ts",
				"convex/assistantConversations.ts",
				"src/features/dashboard/components/dashboard-chatbot.tsx",
				"src/app/workspace/[workspaceId]/assistant/page.tsx"
			]
		},
		"internal_workspace_tools": {
			"status": "implemented",
			"details": [
				"Assistant tools exist for calendar, tasks, channel search/summary, workspace overview, cards, and semantic search.",
				"Tool metadata and invocation context (workspace/user IDs) are defined for AI-driven function calling."
			],
			"evidence_files": ["convex/assistantTools.ts", "convex/assistantChat.ts"]
		},
		"composio_integration": {
			"status": "implemented",
			"details": [
				"Composio auth config and connected account data models are present in Convex schema.",
				"Toolkit-specific actions exist for Gmail, Slack, GitHub, Notion, ClickUp, and Linear.",
				"Next.js API routes exist for Composio status, tools, and auth flow orchestration.",
				"Chatbot route supports OpenAI+Composio path with fallback to Convex assistant path."
			],
			"evidence_files": [
				"convex/schema.ts",
				"convex/integrations.ts",
				"convex/assistantComposioTools.ts",
				"src/app/api/assistant/composio/status/route.ts",
				"src/app/api/assistant/composio/tools/route.ts",
				"src/app/api/assistant/composio/agentauth/route.ts",
				"src/app/api/assistant/chatbot/route.ts",
				"src/lib/composio.ts",
				"src/lib/composio-config.ts"
			]
		}
	},
	"problem_statement": "The assistant stack is largely built, but behavior is split across multiple paths and still needs production hardening (consistency, observability, safety controls, and predictable fallback behavior) to ensure trustworthy task execution.",
	"target_users": [
		"Workspace members using Proddy AI for daily internal coordination",
		"Power users connecting external systems (GitHub/Gmail/Slack/Notion/ClickUp/Linear)"
	],
	"goals": [
		"Unify assistant behavior across Convex-native and OpenAI+Composio execution paths",
		"Ensure reliable member-scoped integration usage and permission boundaries",
		"Increase success rate and explainability for tool-based actions",
		"Ship production-level monitoring, error handling, and user feedback for failed tool operations"
	],
	"non_goals": [
		"Rebuilding existing assistant or integration architecture from scratch",
		"Adding new third-party providers beyond currently integrated toolkits in this phase",
		"Changing core collaboration modules outside assistant scope"
	],
	"scope": {
		"in_scope": [
			"Assistant behavior normalization across `assistantChat` and `/api/assistant/chatbot` paths",
			"Composio connection lifecycle robustness (authorize, complete, status reflection, stale connection handling)",
			"Safety and confirmation policy for high-impact external actions",
			"Auditability of external tool calls and outcomes",
			"Operational observability for assistant and tool-calling failures"
		],
		"out_of_scope": [
			"New vertical products unrelated to assistant",
			"Migration away from Convex as system of record",
			"Full redesign of workspace UX"
		]
	},
	"functional_requirements": [
		{
			"id": "FR-1",
			"requirement": "Assistant must preserve per-user, per-workspace conversation continuity using existing `assistantConversations` and database-chat flows."
		},
		{
			"id": "FR-2",
			"requirement": "When external tools are requested, assistant must prefer member-scoped connections and only fall back to workspace-scoped behavior where explicitly allowed."
		},
		{
			"id": "FR-3",
			"requirement": "Assistant responses must clearly indicate whether execution used internal Convex tools or external Composio tools."
		},
		{
			"id": "FR-4",
			"requirement": "Tool call failures must return actionable user-facing messages and keep chat flow usable without requiring page reload."
		},
		{
			"id": "FR-5",
			"requirement": "High-impact external actions (send, delete, modify permissions, merge, archive) must require explicit user confirmation before execution."
		},
		{
			"id": "FR-6",
			"requirement": "Integration status UI must accurately reflect connected apps and available tool count for the authenticated member context."
		},
		{
			"id": "FR-7",
			"requirement": "System must persist tool execution events (tool name, args snapshot, result/error, actor, timestamps) in Convex for traceability."
		}
	],
	"non_functional_requirements": [
		{
			"id": "NFR-1",
			"requirement": "Assistant endpoint must degrade gracefully: if Composio path fails, Convex assistant fallback remains available unless request is explicitly external-only."
		},
		{
			"id": "NFR-2",
			"requirement": "P95 latency target: <= 4s for non-tool responses and <= 12s for single external-tool round trips under normal load."
		},
		{
			"id": "NFR-3",
			"requirement": "All assistant and integration routes must enforce authentication/authorization checks equivalent to existing member ownership validation patterns."
		},
		{
			"id": "NFR-4",
			"requirement": "Secrets and tokens must never appear in assistant/chat logs, tool results, or client-visible error payloads."
		}
	],
	"known_gaps_from_codebase": [
		{
			"priority": "P0",
			"gap": "Assistant behavior is split across two orchestration paths (Convex action path and Next.js OpenAI+Composio path), increasing inconsistency risk.",
			"impact": "Different prompts/tooling/response formats can produce user confusion and harder debugging."
		},
		{
			"priority": "P0",
			"gap": "No explicit confirmation gate for high-risk external actions before tool execution.",
			"impact": "Unsafe one-shot automation is possible for destructive/sensitive operations."
		},
		{
			"priority": "P1",
			"gap": "Tool execution auditing is not represented as a dedicated, normalized Convex event stream/table.",
			"impact": "Limited forensic traceability and operational analytics for assistant actions."
		},
		{
			"priority": "P1",
			"gap": "Error handling is present but heterogeneous across routes/actions.",
			"impact": "User experience and observability are inconsistent when integrations fail."
		},
		{
			"priority": "P2",
			"gap": "Capability messaging in UI emphasizes some integrations (GitHub/Gmail) more than the full supported set.",
			"impact": "Under-discovery of already available integrations."
		}
	],
	"success_metrics": [
		{
			"metric": "External action success rate",
			"target": ">= 90% for supported connected-tool operations"
		},
		{
			"metric": "Fallback reliability",
			"target": ">= 99% of Composio-path failures return a usable assistant response instead of hard failure"
		},
		{
			"metric": "User-visible error quality",
			"target": "100% of failed tool operations provide actionable reason + next step"
		},
		{
			"metric": "Trace coverage",
			"target": "100% of external tool attempts have persisted audit event records"
		}
	],
	"acceptance_criteria": [
		"A member can open `/workspace/[workspaceId]/assistant`, send messages, and maintain conversation continuity after refresh.",
		"When a connected external app is required, assistant executes via Composio for that member context and returns outcome details.",
		"If Composio/tool execution fails, assistant returns a non-empty fallback response plus an actionable error note.",
		"High-impact actions require explicit confirmation step before execution.",
		"Each external tool attempt is queryable in Convex audit records with actor, tool, timestamp, and result status.",
		"Integration status endpoint and UI agree on connected apps and tool counts for the same workspace/member inputs."
	],
	"milestones": [
		{
			"name": "M1 - Behavior Consolidation",
			"outcome": "Consistent assistant orchestration rules across existing execution paths."
		},
		{
			"name": "M2 - Safety + Audit",
			"outcome": "Confirmation policies and persistent tool-call auditability in Convex."
		},
		{
			"name": "M3 - Reliability Hardening",
			"outcome": "Standardized error handling, fallback quality, and operational metrics dashboards."
		},
		{
			"name": "M4 - Production Readiness",
			"outcome": "Meets success metrics and acceptance criteria for stable rollout."
		}
	],
	"dependencies": [
		"OpenAI API availability and model access",
		"Composio API and toolkit auth config IDs",
		"Convex deployment with required env vars (`OPENAI_API_KEY`, `COMPOSIO_API_KEY`, `NEXT_PUBLIC_CONVEX_URL`)"
	],
	"risks": [
		{
			"risk": "Third-party API/schema drift in Composio toolkits",
			"mitigation": "Adapter layer hardening, compatibility checks, and graceful tool disable paths"
		},
		{
			"risk": "False-positive external intent detection",
			"mitigation": "Intent gating improvements and explicit user confirmation for impactful actions"
		},
		{
			"risk": "Token/latency overhead with large tool sets",
			"mitigation": "Tool filtering, caps, and phased follow-up strategy already present in chatbot route"
		}
	],
	"open_questions": [
		"Should one orchestration path become canonical long-term (Convex action-first vs Next.js route-first)?",
		"What exact action taxonomy should trigger mandatory confirmation in v1 production?",
		"Should audit events be retained indefinitely or under configurable retention windows per workspace?"
	],
	"qualityGates": [
		"bun run type",
		"bun run check",
		"No secrets in logs or client payloads",
		"Assistant fallback path must be preserved"
	],
	"stories": [
		{
			"id": "S1",
			"title": "Unify assistant orchestration behavior",
			"status": "done",
			"dependsOn": [],
			"description": "Standardize runtime behavior between Convex assistant flow and Next.js chatbot route so prompts, tool selection behavior, and response envelope are consistent and predictable.",
			"acceptanceCriteria": [
				"Assistant responses include a consistent metadata shape across both execution paths",
				"Behavior for external-tool and internal-tool queries is documented and deterministic",
				"No regression in conversation creation, message persistence, or streaming"
			],
			"startedAt": "2026-02-12T11:46:56.586150+00:00",
			"completedAt": "2026-02-12T11:53:10.113237+00:00",
			"updatedAt": "2026-02-12T11:53:10.112724+00:00"
		},
		{
			"id": "S2",
			"title": "Add high-impact action confirmation",
			"status": "done",
			"dependsOn": ["S1"],
			"description": "Introduce a confirmation gate before high-risk external actions (send, delete, archive, merge, permission changes) are executed via Composio.",
			"acceptanceCriteria": [
				"High-impact actions are classified and intercepted before execution",
				"User must explicitly confirm before tool execution proceeds",
				"Cancellation path returns clear assistant feedback without side effects"
			],
			"startedAt": "2026-02-12T12:06:02.659705+00:00",
			"completedAt": "2026-02-12T12:14:17.639297+00:00",
			"updatedAt": "2026-02-12T12:14:17.638883+00:00"
		},
		{
			"id": "S3",
			"title": "Persist tool execution audit trail",
			"status": "done",
			"dependsOn": ["S1"],
			"description": "Persist normalized records for external tool attempts in Convex including actor, tool, arguments snapshot (sanitized), outcome, and timestamp.",
			"acceptanceCriteria": [
				"Every external tool attempt writes an audit event",
				"Audit payload omits secrets/tokens",
				"Audit records are queryable by workspace and member"
			],
			"startedAt": "2026-02-12T12:14:19.788082+00:00",
			"completedAt": "2026-02-12T12:23:34.915190+00:00",
			"updatedAt": "2026-02-12T12:23:34.914649+00:00"
		},
		{
			"id": "S4",
			"title": "Harden error handling and fallback UX",
			"status": "in_progress",
			"dependsOn": ["S1"],
			"description": "Normalize error handling across assistant and composio routes so failures produce actionable messages and preserve usable fallback responses.",
			"acceptanceCriteria": [
				"Composio path failures return actionable user-facing messages",
				"Fallback assistant response is returned for recoverable failures",
				"Error logging is consistent and does not leak sensitive data"
			],
			"startedAt": "2026-02-12T12:38:35.878167+00:00",
			"completedAt": null,
			"updatedAt": "2026-02-12T12:38:35.878511+00:00"
		},
		{
			"id": "S5",
			"title": "Align integration status UX with full supported toolkits",
			"status": "open",
			"dependsOn": ["S4"],
			"description": "Ensure assistant UI reflects the full set of supported integrations and member-scoped connection state accurately.",
			"acceptanceCriteria": [
				"Status UI reflects connected apps from member-scoped status endpoint",
				"Tool count and connected app list match backend response",
				"Supported integrations shown are not limited to only GitHub/Gmail"
			]
		}
	]
}
